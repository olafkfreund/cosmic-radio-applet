name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Format checking - fast fail for style issues
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  # Clippy linting - catch issues early
  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxkbcommon-dev \
            libwayland-dev \
            libssl-dev \
            libasound2-dev \
            pkg-config \
            libfontconfig1-dev \
            libfreetype6-dev \
            libexpat1-dev \
            libvulkan-dev \
            libinput-dev \
            libgbm-dev \
            libudev-dev \
            libdbus-1-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Restore cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          # Cache key includes Cargo.lock hash for precise invalidation
          shared-key: "cosmic-radio-applet-clippy"
          cache-on-failure: true

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # Standard cargo build and test
  build-and-test:
    name: Build & Test (Cargo)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [dev, release]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxkbcommon-dev \
            libwayland-dev \
            libssl-dev \
            libasound2-dev \
            pkg-config \
            libfontconfig1-dev \
            libfreetype6-dev \
            libexpat1-dev \
            libvulkan-dev \
            libinput-dev \
            libgbm-dev \
            libudev-dev \
            libdbus-1-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "cosmic-radio-applet-${{ matrix.profile }}"
          cache-on-failure: true

      - name: Build (${{ matrix.profile }})
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --release --locked
          else
            cargo build --locked
          fi

      - name: Run tests (${{ matrix.profile }})
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo test --release --locked
          else
            cargo test --locked
          fi

      - name: Upload binary artifact (release only)
        if: matrix.profile == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: cosmic-radio-applet-${{ github.sha }}
          path: target/release/cosmic-radio-applet
          retention-days: 7

  # Nix flake build - ensures reproducible builds
  nix-build:
    name: Nix Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            # Optimize build performance
            max-jobs = auto
            cores = 0

      - name: Setup Cachix (optional, for caching Nix builds)
        uses: cachix/cachix-action@v14
        with:
          name: cosmic-radio-applet
          # Set CACHIX_AUTH_TOKEN in repository secrets to enable push
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ secrets.CACHIX_AUTH_TOKEN == '' }}

      - name: Restore Nix store cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/nix
            /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Run flake check
        run: nix flake check --show-trace

      - name: Build with Nix
        run: nix build --print-build-logs

      - name: Check flake outputs
        run: |
          echo "=== Available outputs ==="
          nix flake show

          echo "=== Package metadata ==="
          nix eval .#packages.x86_64-linux.default.meta --json | jq

      - name: Test dev shell
        run: |
          nix develop --command bash -c "
            echo 'Testing development environment...'
            which cargo
            which rustc
            rustc --version
            cargo --version
          "

  # Security audit - check for known vulnerabilities
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit

  # Dependency check - validate licenses and outdated deps
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check dependencies
        run: cargo deny check

  # Final status check - all jobs must pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - format
      - clippy
      - build-and-test
      - nix-build
      - security-audit
      - dependency-check
    if: always()
    steps:
      - name: Check all jobs
        run: |
          # Check if any job failed or was cancelled
          if [ "${{ contains(needs.*.result, 'failure') }}" = "true" ] || \
             [ "${{ contains(needs.*.result, 'cancelled') }}" = "true" ]; then
            echo "One or more CI jobs failed or were cancelled"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
